
#include "Display.hpp"

std::map<char, std::array<unsigned char, 8> > Display::_charBitmaps = {
		{'0', {0x7C, 0xC6, 0xCE, 0xDE, 0xF6, 0xE6, 0x7C, 0x00}},
        {'1', {0x30, 0x70, 0x30, 0x30, 0x30, 0x30, 0xFC, 0x00}},
        {'2', {0x78, 0xCC, 0x0C, 0x38, 0x60, 0xCC, 0xFC, 0x00}},
        {'3', {0x78, 0xCC, 0x0C, 0x38, 0x0C, 0xCC, 0x78, 0x00}},
        {'4', {0x1C, 0x3C, 0x6C, 0xCC, 0xFE, 0x0C, 0x1E, 0x00}},
        {'5', {0xFC, 0xC0, 0xF8, 0x0C, 0x0C, 0xCC, 0x78, 0x00}},
        {'6', {0x38, 0x60, 0xC0, 0xF8, 0xCC, 0xCC, 0x78, 0x00}},
        {'7', {0xFC, 0xCC, 0x0C, 0x18, 0x30, 0x30, 0x30, 0x00}},
        {'8', {0x78, 0xCC, 0xCC, 0x78, 0xCC, 0xCC, 0x78, 0x00}},
        {'9', {0x78, 0xCC, 0xCC, 0x7C, 0x0C, 0x18, 0x70, 0x00}},
        {'A', {0x30, 0x78, 0xCC, 0xCC, 0xFC, 0xCC, 0xCC, 0x00}},
        {'B', {0xFC, 0x66, 0x66, 0x7C, 0x66, 0x66, 0xFC, 0x00}},
        {'C', {0x3C, 0x66, 0xC0, 0xC0, 0xC0, 0x66, 0x3C, 0x00}},
        {'D', {0xF8, 0x6C, 0x66, 0x66, 0x66, 0x6C, 0xF8, 0x00}},
        {'E', {0xFE, 0x62, 0x68, 0x78, 0x68, 0x62, 0xFE, 0x00}},
        {'F', {0xFE, 0x62, 0x68, 0x78, 0x68, 0x60, 0xF0, 0x00}},
        {'G', {0x3C, 0x66, 0xC0, 0xC0, 0xCE, 0x66, 0x3E, 0x00}},
        {'H', {0xCC, 0xCC, 0xCC, 0xFC, 0xCC, 0xCC, 0xCC, 0x00}},
        {'I', {0x78, 0x30, 0x30, 0x30, 0x30, 0x30, 0x78, 0x00}},
        {'J', {0x1E, 0x0C, 0x0C, 0x0C, 0xCC, 0xCC, 0x78, 0x00}},
        {'K', {0xE6, 0x66, 0x6C, 0x78, 0x6C, 0x66, 0xE6, 0x00}},
        {'L', {0xF0, 0x60, 0x60, 0x60, 0x62, 0x66, 0xFE, 0x00}},
        {'M', {0xC6, 0xEE, 0xFE, 0xD6, 0xC6, 0xC6, 0xC6, 0x00}},
        {'N', {0xC6, 0xE6, 0xF6, 0xDE, 0xCE, 0xC6, 0xC6, 0x00}},
        {'O', {0x38, 0x6C, 0xC6, 0xC6, 0xC6, 0x6C, 0x38, 0x00}},
        {'P', {0xFC, 0x66, 0x66, 0x7C, 0x60, 0x60, 0xF0, 0x00}},
        {'Q', {0x78, 0xCC, 0xCC, 0xCC, 0xDC, 0x78, 0x1C, 0x00}},
        {'R', {0xFC, 0x66, 0x66, 0x7C, 0x6C, 0x66, 0xE6, 0x00}},
        {'S', {0x78, 0xCC, 0x60, 0x30, 0x18, 0xCC, 0x78, 0x00}},
        {'T', {0xFC, 0xB4, 0x30, 0x30, 0x30, 0x30, 0x78, 0x00}},
        {'U', {0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0x78, 0x00}},
        {'V', {0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0x78, 0x30, 0x00}},
        {'W', {0xC6, 0xC6, 0xC6, 0xD6, 0xFE, 0xEE, 0xC6, 0x00}},
        {'X', {0xC6, 0xC6, 0x6C, 0x38, 0x6C, 0xC6, 0xC6, 0x00}},
        {'Y', {0xCC, 0xCC, 0xCC, 0x78, 0x30, 0x30, 0x78, 0x00}},
        {'Z', {0xFC, 0xCC, 0x98, 0x30, 0x64, 0xCC, 0xFC, 0x00}},
        {' ', {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}},
        {'.', {0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x30, 0x00}},
        {',', {0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x30, 0x20}},
        {'!', {0x30, 0x30, 0x30, 0x30, 0x30, 0x00, 0x30, 0x00}},
        {'?', {0x78, 0xCC, 0x0C, 0x18, 0x30, 0x00, 0x30, 0x00}},
        {':', {0x00, 0x30, 0x30, 0x00, 0x00, 0x30, 0x30, 0x00}},
        {'-', {0x00, 0x00, 0x00, 0x7C, 0x00, 0x00, 0x00, 0x00}},
};

Display::Display()
{
	std::cout << "Opening connection I2C..." << std::endl;
	_fd = open("/dev/i2c-1", O_RDWR);
	if (_fd < 0)
		throw (std::exception());

	std::cout << "Configuring display address.." << std::endl;
	if (ioctl(_fd, I2C_SLAVE, DISPLAY_ADDR) < 0)
		throw (std::exception());
	

	_initDisplay();
}

Display::Display(std::string _testConstructor)
{
	_fd = STDOUT_FILENO;
	_initDisplay();
}
Display::Display(const Display& other): _fd(other._fd), _buffer(other._buffer) {}
Display&	Display::operator=(const Display& other)
{
	if (this != &other)
	{
		_fd = other._fd;
		_buffer = other._buffer;
	}
	return (*this);
}

Display::~Display()
{
	if (_fd > 0)
		close(_fd);
}


void	Display::_initDisplay(void)
{
	_writeCmd(DISPLAY_OFF);
	_writeCmd(SET_CONTRAST);
	_writeCmd(0xFF);

	_writeCmd(SET_MULTIPLEX_RATIO);
	_writeCmd(31);

	_writeCmd(SET_MEM_ADDR_MODE);
	_writeCmd(HORIZONTAL);

	_writeCmd(DISPLAY_START_LINE);
	_writeCmd(SEG_REMAP_RIGHT);
	_writeCmd(COM_SCAN_DOWN);

	_writeCmd(COM_PINS_CONFIG);
	_writeCmd(0x02);

	_writeCmd(0xD5);
	_writeCmd(0x80);

	_writeCmd(0x8D);
	_writeCmd(0x14);

	_resetPrintPos();
	_initBuffer();
	updateDisplay();
	
	_writeCmd(NORMAL_DISPLAY);
	_writeCmd(DISPLAY_ON);

}

void	Display::_initBuffer(void)
{
	_buffer[0] = PXL_ADD;
	_clearBuffer();
}
void	Display::_clearBuffer(void) {std::fill(_buffer.begin() + 1, _buffer.end(), 0);}
void	Display::_fillBuffer(void) {std::fill(_buffer.begin() + 1, _buffer.end(), 0xFF);}
void	Display::_resetPrintPos(void)
{
	_writeCmd(SET_PAGE_NO | 0);
	_writeCmd(0x00);
	_writeCmd(0x10);
}

void	Display::updateDisplay(void)
{
	_resetPrintPos();
	write(_fd, _buffer.data(), _buffer.size());
}

void	Display::_writeCmd(unsigned char data) const
{
	unsigned char	buffer[2];
	buffer[0] = CMD_ADD;
	buffer[1] = data;
	write(_fd, buffer, 2);
}

void	Display::setPixel(int x, int y) {_buffer[y/8*WIDTH+x+1] |= 1<<(y%8);}
void	Display::unsetPixel(int x, int y) {_buffer[y/8*WIDTH+x+1] &= ~(1<<(y%8));}

void	Display::putText(std::string text, int x, int y)
{
	for (int i=0; i<text.size(); i++)
		putChar(text[i], (i*8)+x, y);
}
void	Display::putChar(char c, int x, int y)
{
	std::array<unsigned char, 8>	bitmap = Display::_charBitmaps[c];
	for (int i=0; i<8; i++)
		_buffer[y/8*WIDTH+x+i+1] = bitmap[i];
}